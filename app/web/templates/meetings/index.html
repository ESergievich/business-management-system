{% extends "base.html" %}
{% block title %}Meetings - Business Management System{% endblock %}

{% block content %}
<div class="py-10" x-data="meetingsData()">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Meetings</h1>
                <p class="mt-1 text-sm text-gray-500">Schedule and manage your meetings</p>
            </div>
            <button @click="openCreateModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-500">
                <i class="fas fa-plus mr-2"></i>Schedule Meeting
            </button>
        </div>

        <!-- Upcoming/Past Toggle -->
        <div class="bg-white shadow rounded-lg p-4 mb-6">
            <div class="flex gap-2">
                <button @click="view = 'upcoming'" 
                        :class="view === 'upcoming' ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'bg-gray-100'"
                        class="px-4 py-2 rounded-md text-sm">
                    Upcoming (<span x-text="upcomingMeetings.length"></span>)
                </button>
                <button @click="view = 'past'" 
                        :class="view === 'past' ? 'bg-gray-300 text-gray-700 font-semibold' : 'bg-gray-100'"
                        class="px-4 py-2 rounded-md text-sm">
                    Past (<span x-text="pastMeetings.length"></span>)
                </button>
            </div>
        </div>

        <!-- Meetings List -->
        <div class="space-y-4">
            <template x-for="meeting in displayedMeetings" :key="meeting.id">
                <div class="bg-white shadow rounded-lg p-6 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-semibold" x-text="meeting.title"></h3>
                                <span x-show="isToday(meeting.start_time)" class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">
                                    Today
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3" x-text="meeting.description || 'No description'"></p>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                <span>
                                    <i class="far fa-calendar mr-1"></i>
                                    <span x-text="formatDate(meeting.start_time)"></span>
                                </span>
                                <span>
                                    <i class="far fa-clock mr-1"></i>
                                    <span x-text="formatTime(meeting.start_time) + ' - ' + formatTime(meeting.end_time)"></span>
                                </span>
                                <span>
                                    <i class="fas fa-users mr-1"></i>
                                    <span x-text="meeting.participants?.length || 0 + ' participants'"></span>
                                </span>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button @click="viewMeeting(meeting)" class="text-indigo-600 hover:text-indigo-800 p-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button x-show="meeting.organizer_id === {{ user.id }}" 
                                    @click="confirmCancel(meeting)" 
                                    class="text-red-600 hover:text-red-800 p-2">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            
            <template x-if="displayedMeetings.length === 0">
                <div class="bg-white shadow rounded-lg p-12 text-center">
                    <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500" x-text="view === 'upcoming' ? 'No upcoming meetings' : 'No past meetings'"></p>
                </div>
            </template>
        </div>
    </div>

    <!-- Create Meeting Modal -->
    <div x-show="showModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div @click.away="showModal = false" class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Schedule Meeting</h3>
            <form @submit.prevent="createMeeting">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                        <input x-model="newMeeting.title" type="text" required
                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea x-model="newMeeting.description" rows="2"
                                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Time *</label>
                            <input x-model="newMeeting.start_time" type="datetime-local" required
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Time *</label>
                            <input x-model="newMeeting.end_time" type="datetime-local" required
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Team *</label>
                        <select x-model="newMeeting.team_id" required
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="">Select team...</option>
                            <template x-for="team in teams" :key="team.id">
                                <option :value="team.id" x-text="team.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Participants</label>
                        <div class="border rounded-md p-3 max-h-48 overflow-y-auto space-y-2">
                            <template x-for="member in getTeamMembers(newMeeting.team_id)" :key="member.id">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           :value="member.id"
                                           @change="toggleParticipant(member.id)"
                                           :checked="newMeeting.participant_ids.includes(member.id)"
                                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm" x-text="member.username + ' (' + member.email + ')'"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-2">
                    <button @click="showModal = false" type="button" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-500">
                        Schedule Meeting
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Meeting Details Modal -->
    <div x-show="showDetailsModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div @click.away="showDetailsModal = false" class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-semibold" x-text="selectedMeeting?.title"></h3>
                    <p class="text-sm text-gray-500 mt-1">
                        <i class="far fa-calendar mr-1"></i>
                        <span x-text="selectedMeeting ? formatDate(selectedMeeting.start_time) : ''"></span>
                    </p>
                </div>
                <button @click="showDetailsModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Description</h4>
                    <p class="text-gray-600" x-text="selectedMeeting?.description || 'No description'"></p>
                </div>
                
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Time</h4>
                    <p class="text-gray-600">
                        <span x-text="selectedMeeting ? formatTime(selectedMeeting.start_time) : ''"></span>
                        - 
                        <span x-text="selectedMeeting ? formatTime(selectedMeeting.end_time) : ''"></span>
                    </p>
                </div>
                
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Participants</h4>
                    <div class="space-y-2">
                        <template x-for="participant in selectedMeeting?.participants || []" :key="participant.id">
                            <div class="flex items-center p-2 bg-gray-50 rounded">
                                <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-sm font-semibold">
                                    <span x-text="participant.username[0].toUpperCase()"></span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium" x-text="participant.username"></p>
                                    <p class="text-xs text-gray-500" x-text="participant.email"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function meetingsData() {
    return {
        meetings: [],
        teams: [],
        view: 'upcoming',
        showModal: false,
        showDetailsModal: false,
        selectedMeeting: null,
        newMeeting: {
            title: '',
            description: '',
            start_time: '',
            end_time: '',
            team_id: '',
            participant_ids: []
        },
        
        get upcomingMeetings() {
            const now = new Date();
            return this.meetings.filter(m => new Date(m.start_time) > now)
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
        },
        
        get pastMeetings() {
            const now = new Date();
            return this.meetings.filter(m => new Date(m.start_time) <= now)
                .sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
        },
        
        get displayedMeetings() {
            return this.view === 'upcoming' ? this.upcomingMeetings : this.pastMeetings;
        },
        
        async init() {
            await Promise.all([this.loadMeetings(), this.loadTeams()]);
        },
        
        async loadMeetings() {
            try {
                this.meetings = await apiCall('/v1/meetings/');
            } catch (error) {
                showFlash('Failed to load meetings', 'error');
            }
        },
        
        async loadTeams() {
            try {
                const user = await apiCall('/v1/users/me');
                if (user.teams) {
                    const teamPromises = user.teams.map(t => apiCall(`/v1/teams/${t.id}/members`));
                    this.teams = await Promise.all(teamPromises);
                }
            } catch (error) {
                console.error('Failed to load teams');
            }
        },
        
        getTeamMembers(teamId) {
            const team = this.teams.find(t => t.id == teamId);
            return team?.members || [];
        },
        
        toggleParticipant(userId) {
            const index = this.newMeeting.participant_ids.indexOf(userId);
            if (index > -1) {
                this.newMeeting.participant_ids.splice(index, 1);
            } else {
                this.newMeeting.participant_ids.push(userId);
            }
        },
        
        openCreateModal() {
            this.newMeeting = {
                title: '',
                description: '',
                start_time: '',
                end_time: '',
                team_id: '',
                participant_ids: []
            };
            this.showModal = true;
        },
        
        async createMeeting() {
            try {
                const payload = {
                    ...this.newMeeting,
                    start_time: new Date(this.newMeeting.start_time).toISOString(),
                    end_time: new Date(this.newMeeting.end_time).toISOString()
                };
                
                await apiCall('/v1/meetings/', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                showFlash('Meeting scheduled successfully!', 'success');
                this.showModal = false;
                await this.loadMeetings();
            } catch (error) {
                showFlash(error.message, 'error');
            }
        },
        
        async viewMeeting(meeting) {
            try {
                this.selectedMeeting = await apiCall(`/v1/meetings/${meeting.id}`);
                this.showDetailsModal = true;
            } catch (error) {
                showFlash('Failed to load meeting details', 'error');
            }
        },
        
        confirmCancel(meeting) {
            if (confirm(`Cancel meeting "${meeting.title}"?`)) {
                this.cancelMeeting(meeting.id);
            }
        },
        
        async cancelMeeting(meetingId) {
            try {
                await apiCall(`/v1/meetings/${meetingId}`, { method: 'DELETE' });
                showFlash('Meeting cancelled', 'success');
                await this.loadMeetings();
            } catch (error) {
                showFlash(error.message, 'error');
            }
        },
        
        isToday(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            return date.toDateString() === today.toDateString();
        },
        
        formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
    }
}
</script>
{% endblock %}