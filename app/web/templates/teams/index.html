{% extends "base.html" %}
{% block title %}Teams - Business Management System{% endblock %}

{% block content %}
<div class="py-10" x-data="teamsData()">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Teams</h1>
                <p class="mt-1 text-sm text-gray-500">Manage your teams and collaborate with members</p>
            </div>
            <div class="flex gap-2">
                <button @click="showJoinModal = true" class="bg-white text-indigo-600 border border-indigo-600 px-4 py-2 rounded-md hover:bg-indigo-50 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Join Team
                </button>
                {% if user.role == 'admin' %}
                <button @click="showCreateModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-500 transition">
                    <i class="fas fa-plus mr-2"></i>Create Team
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Teams Grid -->
        <template x-if="loading">
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
                <p class="mt-4 text-gray-500">Loading teams...</p>
            </div>
        </template>

        <template x-if="!loading && teams.length === 0">
            <div class="text-center py-12 bg-white rounded-lg shadow">
                <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No teams yet</h3>
                <p class="text-gray-500 mb-6">Create a new team or join an existing one</p>
                <button @click="showJoinModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-500">
                    Join a Team
                </button>
            </div>
        </template>

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <template x-for="team in teams" :key="team.id">
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900" x-text="team.name"></h3>
                            <p class="text-sm text-gray-500 mt-1">
                                <i class="fas fa-users mr-1"></i>
                                <span x-text="(team.members?.length || 0) + ' members'"></span>
                            </p>
                        </div>
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div x-show="open" @click.away="open = false"
                                 class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                                <button @click="viewTeamDetails(team); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-eye mr-2"></i>View Details
                                </button>
                                {% if user.role in ['admin', 'manager'] %}
                                <button @click="openManageMembersModal(team); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-users-cog mr-2"></i>Manage Members
                                </button>
                                {% endif %}
                                <button @click="confirmLeaveTeam(team); open = false" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Leave Team
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Invite Code</span>
                            <button @click="copyInviteCode(team.invite_code)" class="text-xs text-indigo-600 hover:text-indigo-800 font-mono">
                                <i class="fas fa-copy mr-1"></i>
                                <span x-text="team.invite_code"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div x-show="showCreateModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div @click.away="showCreateModal = false" class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Create New Team</h3>
            <form @submit.prevent="createTeam">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
                    <input x-model="newTeam.name" type="text" required
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div class="flex justify-end gap-2">
                    <button @click="showCreateModal = false" type="button" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-500">
                        Create Team
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Join Team Modal -->
    <div x-show="showJoinModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div @click.away="showJoinModal = false" class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Join Team</h3>
            <form @submit.prevent="joinTeam">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Invite Code</label>
                    <input x-model="joinCode" type="text" required placeholder="Enter team invite code"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <p class="mt-1 text-xs text-gray-500">Ask your team admin for the invite code</p>
                </div>
                <div class="flex justify-end gap-2">
                    <button @click="showJoinModal = false" type="button" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-500">
                        Join Team
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Details Modal -->
    <div x-show="showDetailsModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div @click.away="showDetailsModal = false" class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-semibold" x-text="selectedTeam?.name"></h3>
                    <p class="text-sm text-gray-500 mt-1">
                        <i class="fas fa-key mr-1"></i>
                        Invite Code: <span class="font-mono" x-text="selectedTeam?.invite_code"></span>
                    </p>
                </div>
                <button @click="showDetailsModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Team Members</h4>
                    <div class="space-y-2">
                        <template x-for="member in selectedTeam?.members || []" :key="member.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-semibold">
                                        <span x-text="member.username[0].toUpperCase()"></span>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900" x-text="member.username"></p>
                                        <p class="text-xs text-gray-500" x-text="member.email"></p>
                                    </div>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-800" x-text="member.role"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Members Modal -->
    <div x-show="showManageMembersModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div @click.away="showManageMembersModal = false" class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl font-semibold">Manage Team Members</h3>
                <button @click="showManageMembersModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Add Member Form -->
            <form @submit.prevent="addMember" class="mb-6 pb-6 border-b">
                <label class="block text-sm font-medium text-gray-700 mb-2">Add Member by Email</label>
                <div class="flex gap-2">
                    <input x-model="newMemberId" placeholder="Enter member id"
                           class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500">
                        <i class="fas fa-plus mr-1"></i>Add
                    </button>
                </div>
            </form>

            <!-- Current Members -->
            <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Current Members</h4>
                <div class="space-y-2">
                    <template x-for="member in selectedTeam?.members || []" :key="member.id">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-semibold">
                                    <span x-text="member.username[0].toUpperCase()"></span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900" x-text="member.username"></p>
                                    <p class="text-xs text-gray-500" x-text="member.email"></p>
                                </div>
                            </div>
                            <button @click="confirmRemoveMember(member)"
                                    class="text-red-600 hover:text-red-800 px-3 py-1 text-sm">
                                <i class="fas fa-times mr-1"></i>Remove
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function teamsData() {
    const userRole = '{{ user.role.value }}';
    const userId = {{ user.id }};

    return {
        teams: [],
        allUsers: [],
        selectedTeam: null,
        loading: true,
        showCreateModal: false,
        showJoinModal: false,
        showDetailsModal: false,
        showManageMembersModal: false,
        newTeam: { name: '' },
        joinCode: '',
        newMemberId: '',

        async init() {
            await this.loadTeams();
            if (userRole === 'admin' || userRole === 'manager') {
                await this.loadAllUsers();
            }
        },

        async loadTeams() {
            this.loading = true;
            try {
                // API endpoint returns only teams user belongs to (except for admin)
                this.teams = await apiCall('/v1/teams');
            } catch (error) {
                showFlash('Failed to load teams', 'error');
            } finally {
                this.loading = false;
            }
        },

        async loadAllUsers() {
            try {
                // Load all users for adding to team
                const response = await apiCall('/v1/users/me');
                // We'll load users when needed in addMember
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        },

        async createTeam() {
            try {
                await apiCall('/v1/teams', {
                    method: 'POST',
                    body: JSON.stringify(this.newTeam)
                });
                showFlash('Team created successfully!', 'success');
                this.showCreateModal = false;
                this.newTeam = { name: '' };
                await this.loadTeams();
            } catch (error) {
                showFlash(error.message, 'error');
            }
        },

        async joinTeam() {
            try {
                await apiCall('/v1/teams/join', {
                    method: 'POST',
                    body: JSON.stringify({ invite_code: this.joinCode })
                });
                showFlash('Joined team successfully!', 'success');
                this.showJoinModal = false;
                this.joinCode = '';
                await this.loadTeams();
            } catch (error) {
                showFlash(error.message, 'error');
            }
        },

        confirmLeaveTeam(team) {
            if (confirm(`Are you sure you want to leave "${team.name}"?`)) {
                this.leaveTeam(team.id);
            }
        },

        async leaveTeam(teamId) {
            try {
                await apiCall(`/v1/teams/${teamId}/leave`, { method: 'DELETE' });
                showFlash('Left team successfully', 'success');
                await this.loadTeams();
            } catch (error) {
                showFlash(error.message, 'error');
            }
        },

        async viewTeamDetails(team) {
            try {
                // Reload team with full member details
                this.selectedTeam = await apiCall(`/v1/teams/${team.id}/members`);
                this.showDetailsModal = true;
            } catch (error) {
                showFlash('Failed to load team details', 'error');
            }
        },

        async openManageMembersModal(team) {
            // Check if user has permission
            if (userRole === 'admin' || (userRole === 'manager' && this.isUserInTeam(team))) {
                try {
                    this.selectedTeam = await apiCall(`/v1/teams/${team.id}/members`);
                    this.showManageMembersModal = true;
                } catch (error) {
                    showFlash('Failed to load team details', 'error');
                }
            } else {
                showFlash('You do not have permission to manage this team', 'error');
            }
        },

        isUserInTeam(team) {
            return team.members?.some(m => m.id === userId);
        },

        async addMember() {
            if (!this.newMemberId || !this.selectedTeam) return;

            try {
                const userIdToAdd = Number(this.newMemberId);

                if (isNaN(userIdToAdd)) {
                    showFlash('User ID must be a number', 'error');
                    return;
                }

                await apiCall(`/v1/teams/${this.selectedTeam.id}/members/${userIdToAdd}`, {
                    method: 'POST'
                });

                showFlash('User added successfully!', 'success');

                this.newMemberId = '';

                // ðŸ”¥ ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
                this.selectedTeam = await apiCall(`/v1/teams/${this.selectedTeam.id}/members`);

            } catch (error) {
                showFlash(error.message, 'error');
            }
        },

        confirmRemoveMember(member) {
            if (member.id === userId) {
                showFlash('You cannot remove yourself. Use "Leave Team" instead.', 'warning');
                return;
            }

            if (confirm(`Remove ${member.username} from the team?`)) {
                this.removeMember(member.id);
            }
        },

        async removeMember(memberId) {
            try {
                await apiCall(`/v1/teams/${this.selectedTeam.id}/members/${memberId}`, {
                    method: 'DELETE'
                });
                showFlash('Member removed successfully', 'success');
                await this.openManageMembersModal(this.selectedTeam);
                await this.loadTeams();
            } catch (error) {
                showFlash(error.message, 'error');
            }
        },

        copyInviteCode(code) {
            navigator.clipboard.writeText(code);
            showFlash('Invite code copied to clipboard!', 'success');
        }
    }
}
</script>
{% endblock %}